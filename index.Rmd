---
title: "Herrings Data Analysis"
author: "Filip Szóstak"
date: "`r Sys.Date()`"
output:
  html_document: 
    self_contained: yes
    toc: yes
    toc_float: yes
    theme: spacelab
    number_sections: yes
    df_print: kable
---
 
```{r setup, include=FALSE, cache = FALSE}
knitr::opts_chunk$set(echo = FALSE)
set.seed(23)
```

```{r libraries, include=FALSE}
library(dplyr)
library(ggplot2)
library(plotly)
library(knitr)
library(egg)
library(tidyr)
```

# Executive summary 

# Problem

Raport służy do analizy potencjalnych przyczyn stopniowego karłowacenia śledzi oceanicznych wyławianych w Europie.

## Źródło danych

Do analizy wykorzystano zbiór danych udostępniony przez prowadzącego na podstawie danych z połowów komercyjnych jednostek w przeciągu ostatnich 60 lat. Do analizy z połowu każdej jednostki wybierano między 50 a 100 sztuk trzyletnich śledzi. 

## Zbiór danych
 
Zbiór składa się z następujących danych:

- `length` - analizowana długość złowionego śledzia [cm]
- `cfin1` - dostępność planktonu [zagęszczenie *Calanus finmarchicus* gat. 1];
- `cfin2` - dostępność planktonu [zagęszczenie *Calanus finmarchicus* gat. 2];
- `chel1` - dostępność planktonu [zagęszczenie *Calanus helgolandicus* gat. 1];
- `chel2` - dostępność planktonu [zagęszczenie *Calanus helgolandicus* gat. 2];
- `lcop1` - dostępność planktonu [zagęszczenie widłonogów gat. 1];
- `lcop2` - dostępność planktonu [zagęszczenie widłonogów gat. 2];
- `fbar` - natężenie połowów w regionie [ułamek pozostawionego narybku];
- `recr` - roczny narybek [liczba śledzi];
- `cumf` - łączne roczne natężenie połowów w regionie [ułamek pozostawionego narybku];
- `totaln` - łączna liczba ryb złowionych w ramach połowu [liczba śledzi];
- `sst` - temperatura przy powierzchni wody [°C];
- `sal` - poziom zasolenia wody [Knudsen ppt];
- `xmonth`-  miesiąc połowu [numer miesiąca];
- `nao` - oscylacja północnoatlantycka [mb].

```{r loading, cache=TRUE}
data.df <- read.csv(
  file = 'herrings.csv', 
  quote = "", 
  comment.char = "", 
  na.strings="?",
  colClasses = c("integer", rep("numeric", 8), "integer", rep("numeric", 4), "factor", "numeric")
  )

full.count <- nrow(data.df)

df <- data.df[complete.cases(data.df),]
reduced.count <- nrow(df)  
```

## Wartości puste

W zbiorze danych pojawiają się braki wartości w przypadku kolumn: `cfin1`, `cfin2`, `chel1`, `chel2`, `lcop1`, `lcop2`, `sst`.
Z uwagi na to, jesteśmy zmuszeni je odfiltrować, redukując ilość danych z `r full.count` do `r reduced.count` (`r round(reduced.count/full.count*100)`% danych jest pełnych). 


# Analiza 

## Podsumowanie danych

```{r data_summary}
summarized_data <-summary(df[,-c(1,15) ])
kable(head(summarized_data[, 1:7]))
kable(head(summarized_data[, 8:14]))
```

## Szczegółowa analiza atrybutów

### Długość
```{r analysis, cache=FALSE}
present_variable <- function(data, column, binwidth, columnName) {
  p1 <- ggplot(data, aes(x=column)) +
    geom_histogram(aes(y=after_stat(density)), binwidth=binwidth, fill='lightblue', color=alpha('darkblue', 0.1)) + 
    geom_density(color=alpha('black', 0.6)) + 
    labs(x=columnName)
  
  p2 <- ggplot(data, aes(y=column)) +
    geom_boxplot() + 
    coord_flip() + 
    labs(y=columnName) +
    theme(
      axis.text.y = element_blank(),
      axis.ticks.y = element_blank()
      )
  ggarrange(p1, p2, heights=c(3,1))
}
 
```

```{r analysis_length, cache=FALSE}
present_variable(df, df$length, binwidth = 0.5, 'length')
```

### Dostępność planktonów

```{r analysis_plancton}
present_variable(df, df$cfin1, binwidth = 1, 'cfin1')
```

### Natężenia połowów

```{r analysis_fbar}
present_variable(df, df$fbar, binwidth = 0.05, 'fbar')
```

### Roczny narybek

```{r analysis_recr}
ggplot(df, aes(x=recr)) +
  geom_density()
```

### Roczne natężenie połowów w rejonie

```{r analysis_cumf}
ggplot(df, aes(x=cumf)) +
  geom_density()
```

### Łączna liczb ryb złowionych w ramach połowu

```{r analysis_totaln}
ggplot(df, aes(x=totaln)) +
  geom_density()
```

### Temperatura przy powierzchni wody

```{r analysis_sst}
ggplot(df, aes(x=sst)) +
  geom_density()
```

### Poziom zasolenia wody

```{r analysis_sal}
ggplot(df, aes(x=sal)) +
  geom_density()
```

### Miesiąc połowu

```{r analysis_xmonth}
ggplot(df, aes(x=xmonth)) +
  geom_density()
```

### Oscylacja północnoatlantycka

```{r analysis_nao}
ggplot(df, aes(x=nao)) +
  geom_density()
```

## Analiza korelacji między zmiennymi

```{r correlation_chart}
df %>%
  sample_n(100) %>%
  select(-c(X, xmonth)) %>%
  gather("key", "value", c(-1)) %>%
  ggplot(aes(x = value, y = length)) +
    facet_wrap(. ~ key, scales = 'free') + 
    geom_point() + 
  theme(axis.text.x = element_text(angle=90, vjust=0.5, hjust=1))
```

```{r correlation_table}
correlations = df %>%
  select(-c(X, xmonth)) %>%
  cor()

kable(round(correlations[, 1:7], digits=2))
kable(round(correlations[, 8:14], digits=2))

```
## Przewidywanie rozmiaru śledzia

# Wnioski
